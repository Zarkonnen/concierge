<!DOCTYPE html>
<html style="margin: 0; padding: 0;">
    <head>
        <title>Concierge</title>
        <script src="jquery-3.1.1.min.js"></script>
        <script src="howler.min.js"></script>
    </head>
    <body style="margin: 0; padding: 0; background: #333333;">
        <canvas width="800" height="600" allowfullscreen="true" id="gameCanvas" style="margin-left: 10px; margin-top: 10px;"></canvas>
        <script>
var peopleList = [
    {
        id: "spy",
        head: "spyhead",
        activeHead: "spyactivehead",
        body: "spybody",
        activeTool: "spygun",
        name: "Septimus Smith",
        intro: "The name's Smith. Septimus Smith.",
        animation: "standing",
        animationT: 0,
        x: 0,
        y: 0,
        active: false
    },
    {
        id: "werewolf",
        head: "werewolfhead",
        activeHead: "werewolfactivehead",
        body: "werewolfbody",
        activeBody: "werewolfactivebody",
        activeTool: "werewolfclaw",
        name: "U.P. Garoul",
        intro: "Lovely moon tonight, er, right?",
        animation: "standing",
        animationT: 0,
        x: 0,
        y: 0,
        active: false,
        alive: true,
        moved: false,
        neutralized: false,
        priority: 1,
        moveTo: -5,
        attacks: true,
        strength: 3
    },
    {
        id: "murderer",
        head: "murdererhead",
        activeHead: "murdereractivehead",
        body: "murdererbody",
        activeTool: "murdereraxe",
        name: "Mr. Grushko",
        intro: "I am Mister Grushko. One room, please.",
        animation: "standing",
        animationT: 0,
        x: 0,
        y: 0,
        active: false
    },
    {
        id: "suicide",
        head: "suicidehead",
        activeHead: "suicideactivehead",
        body: "suicidebody",
        activeTool: "suicidegun",
        name: "Werther Junge",
        intro: "It's OK if I pay in the morning, right?",
        animation: "standing",
        animationT: 0,
        x: 0,
        y: 0,
        active: false
    },
    {
        id: "cultist",
        head: "cultisthead",
        activeHead: "cultistactivehead",
        body: "cultistbody",
        activeBody: "cultistactivebody",
        activeTool: "cultiststaff",
        name: "Philippa Marsh",
        intro: "Greetings. Is my room ready?",
        animation: "standing",
        animationT: 0,
        x: 0,
        y: 0,
        active: false
    },
    {
        id: "snorer",
        head: "snorerhead",
        activeHead: "snoreractivehead",
        body: "snorerbody",
        name: "Mr. O'Doul",
        intro: "Can't wait for a good night's sleep, eh?",
        animation: "standing",
        animationT: 0,
        x: 0,
        y: 0,
        active: false
    },
    {
        id: "granny",
        head: "grannyhead",
        body: "grannybody",
        name: "Mrs. Spelt",
        intro: "Hello, dearie.",
        animation: "standing",
        animationT: 0,
        x: 0,
        y: 0,
        active: false
    },
    {
        id: "priest",
        head: "priesthead",
        body: "priestbody",
        activeTool: "priestcross",
        name: "Father Rumbucket",
        intro: "Hello.",
        animation: "standing",
        animationT: 0,
        x: 0,
        y: 0,
        active: false
    },
    {
        id: "vamp",
        head: "vamphead",
        activeHead: "vampactivehead",
        body: "vampbody",
        activeBody: "vampactivebody",
        name: "Raquelle",
        intro: "Hi! *giggles*",
        animation: "standing",
        animationT: 0,
        x: 0,
        y: 0,
        active: false
    },
    {
        id: "vampire",
        head: "vampirehead",
        activeHead: "vampireactivehead",
        body: "vampirebody",
        name: "A.L. Ucard",
        intro: "Hello, my friend. One room please. I won't be needing dinner.",
        animation: "standing",
        animationT: 0,
        introParticles: {
            color: "black",
            number: 100,
            size: 80,
            speed: 0.5,
            life: 500
        },
        x: 0,
        y: 0,
        active: false
    },
    {
        id: "thief",
        head: "thiefhead",
        body: "thiefbody",
        activeTool: "thiefcrowbar",
        name: "T. Felofavan", // It fell off a van
        intro: "Lovely hotel you've got here.",
        animation: "standing",
        animationT: 0,
        x: 0,
        y: 0,
        active: false
    },
    {
        id: "insomniac",
        head: "insomniachead",
        activeHead: "insomniacactivehead",
        body: "insomniacbody",
        activeTool: "insomniacknife",
        name: "S. Onpyh",
        intro: "I'd like your quietest room.",
        animation: "standing",
        animationT: 0,
        x: 0,
        y: 0,
        active: false
    },
];
var people = {};
for (var i = 0; i < peopleList.length; i++) {
    people[peopleList[i].id] = peopleList[i];
}

// State
var night = false;
var intro = true;
var managerOut = true;
var introLine = 0;
var introLines = ["I'm sick of you re-assigning guests for trivial reasons!", "In this hotel, each guest gets one room and stays in it!", "And those terrible deaths in recent weeks...", "We can afford no more negative press, no more corpses in our rooms.", "Now get to work - I see today's first guest coming in."];
var assignGuest = false;
var guestWait = 0;
var managerX = 0;
var manager = {
    head: "managerhead",
    body: "managerbody",
    animation: "talking",
    animationT: 0
};
var guestIDs = {};
var guest = pickGuest();
var guestSaidHello = false;
var animating = null;
var turnGuest = null;
var turnGuestRoom = null;
var targetRoom = null;
var moving = null;
var movingFrom = null;
var movingTo = null;
var movingToRight = false;
var movingToState = 0;
var particles = [];
var rooms = [
    {
        name: "Room 1",
        x: 256,
        y: 31.5,
        w: 182,
        h: 242,
        occupant: null,
        bottom: false
    },
    {
        name: "Room 2",
        x: 256 + 205,
        y: 31.5,
        w: 182,
        h: 242,
        occupant: null,
        bottom: false
    },
    {
        name: "Room 3",
        x: 256 + 205 * 2,
        y: 31.5,
        w: 182,
        h: 242,
        occupant: null,
        bottom: false
    },
    {
        name: "Room 4",
        x: 256 + 205 * 2,
        y: 426.5,
        w: 182,
        h: 242,
        occupant: null,
        bottom: true
    },
    {
        name: "Room 5",
        x: 256 + 205,
        y: 426.5,
        w: 182,
        h: 242,
        occupant: null,
        bottom: true
    },
    {
        name: "Room 6",
        x: 256,
        y: 426.5,
        w: 182,
        h: 242,
        occupant: null,
        bottom: true
    }
];

function instaNight() {
    guestIDs = {};
    for (var i = 0; i < rooms.length; i++) {
        var room = rooms[i];
        room.occupant = pickGuest();
        room.occupant.x = room.x + room.w / 4;
        room.occupant.y = room.y + room.h / 2;
    }
    night = true;
}

function isFull() {
    for (var i = 0; i < rooms.length; i++) {
        if (!rooms[i].occupant) { return false; }
    }
    return true;
}

function pickGuest() {
    var ids = peopleList.map(function(p) { return p.id; }).filter(function(id) { return !guestIDs[id]; });
    var guestID = ids[Math.floor(Math.random() * ids.length)];
    if (!guestIDs.werewolf) {
        guestID = "werewolf";
    }
    guestIDs[guestID] = 1;
    var guest = people[guestID];
    animate(guest, guest.introParticles ? "standing" : "walking");
    return guest;
}

function animate(person, animation) {
    person.animation = animation;
    person.animationT = 0;
}

function animTick(person, ms) {
    person.animationT += ms;
    if (person.animationT > animLengths[person.animation]) {
        person.animation = "standing";
        person.animationT = 0;
        return null;
    }
    return person;
}

function doAnim(person, animation) {
    animate(person, animation);
    animating = person;
}

var MT_START = 0;
var MT_SRC_CENTER = 1;
var MT_SRC_CORRIDOR = 2;
var MT_TRG_CORRIDOR = 3;
var MT_TRG_CENTER = 4;
var MT_END = 5;

function doMove(person, from, room, right) {
    animate(person, "moving");
    animating = person;
    moving = person;
    movingFrom = from;
    movingTo = room;
    movingToRight = right;
    movingToState = MT_START;
}

var animLengths = {
    activating: 385,
    walking: 100000,
    standing: 100000,
    killing: 1000,
    neutralizing: 2000,
    seducing: 2000,
    angry: 1500,
    suicide: 3000,
    fucking: 3000,
    talking: 1550
};

function input(ms) {
    if (!night) {
        instaNight();
        return;
    }
    if (night) {
        // Just watch.
    } else if (assignGuest) {
        if (click) {
            for (var i = 0; i < rooms.length; i++) {
                var room = rooms[i];
                if (!room.occupant && click.x / scale > room.x + w / 2 - 500 && click.x / scale < room.x + room.w + w / 2 - 500 && click.y / scale > room.y && click.y / scale < room.y + room.h) {
                    room.occupant = guest;
                    guest.x = room.x + room.w / 4;
                    guest.y = room.y + room.h / 2;
                    if (isFull()){
                        guest = null;
                        assignGuest = false;
                        night = true;
                    } else {
                        guest = pickGuest();
                        guestWait = 500;
                        assignGuest = false;
                        guestSaidHello = false;
                    }
                }
            }
        }
    } else {
        if (intro) {
            if (click) {
                introLine++;
                if (introLine >= introLines.length) {
                    intro = false;
                    return;
                }
                animate(manager, "talking");
            }
        } else if (managerOut) {
            managerX += ms * 2;
            if (managerX > 1200) {
                managerOut = false;
                guestWait = 500;
            }
        } else if (guestWait == 0 && !guestSaidHello) {
            guestSaidHello = true;
            animate(guest, "talking");
        } else if (guestWait == 0 && guestSaidHello && click && cursor.x / scale > w / 2 - 100 && cursor.x / scale < w / 2 + 100 && cursor.y / scale > 600 && cursor.y / scale < 650) {
            assignGuest = true;
        }
    }
    click = null;
}

function update(ms) {
    for (var i = 0; i < particles.length; i++) {
        var p = particles[i];
        p.life -= ms;
        p.x += p.dx * ms;
        p.y += p.dy * ms;
        if (p.life <= 0) {
            particles.splice(i, 1);
            i--;
        }
    }
    if (night) {
        if (animating) {
            animating = animTick(animating, ms);
            if (moving) {
                var tx = 0;
                var ty = 0;
                switch (movingToState) {
                    case MT_START:
                        tx = movingFrom.x + movingFrom.w / 2;
                        ty = movingFrom.bottom ? (movingFrom.y + movingFrom.h * 1 / 4) : (movingFrom.y + movingFrom.h * 3 / 4);
                        break;
                    case MT_SRC_CENTER:
                        tx = movingFrom.x + movingFrom.w / 2;
                        ty = 350;
                        break;
                    case MT_SRC_CORRIDOR:
                        tx = movingTo.x + movingTo.w / 2;
                        ty = 350;
                        break;
                    case MT_TRG_CORRIDOR:
                        tx = movingTo.x + movingTo.w / 2;
                        ty = movingTo.bottom ? (movingTo.y + movingTo.h * 1 / 4) : (movingTo.y + movingTo.h * 3 / 4);
                        break;
                    case MT_TRG_CENTER:
                        tx = movingToRight ? (movingTo.x + movingTo.w * 3 / 4) : (movingTo.x + movingTo.w * 1 / 4);
                        ty = movingTo.y + movingTo.h / 2;
                        break;
                    case MT_END:
                        break;
                }
                var spd = ms * 0.08;
                var distSq = (moving.x - tx) * (moving.x - tx) + (moving.y - ty) * (moving.y - ty);
                if (distSq < spd * spd) {
                    moving.x = tx;
                    moving.y = ty;
                    movingToState++;
                    if (movingToState == MT_END) {
                        animate(moving, "standing");
                        animating = null;
                        moving = null;
                    }
                } else {
                    var angle = Math.atan2(ty - moving.y, tx - moving.x);
                    moving.x += Math.cos(angle) * spd;
                    moving.y += Math.sin(angle) * spd;
                }
            }
        } else {
            if (!turnGuest) {
                for (var i = 0; i < rooms.length; i++) {
                    var occupant = rooms[i].occupant;
                    if (occupant.priority && !occupant.moved && occupant.alive && !occupant.neutralized && (!turnGuest || occupant.priority < turnGuest)) {
                        turnGuest = occupant;
                        turnGuestRoom = rooms[i];
                    }
                }
            }
            if (!turnGuest) {
                // qqDPS Final Score
                return;
            }
            if (!turnGuest.active) {
                turnGuest.active = true;
                doAnim(turnGuest, "activating");
                return;
            }
            if (turnGuest.moveTo && !targetRoom) {
                targetRoom = rooms[(rooms.indexOf(turnGuestRoom) + turnGuest.moveTo + rooms.length) % rooms.length];
                doMove(turnGuest, turnGuestRoom, targetRoom, true);
                return;
            }
        }
    } else {
        if (guest) {
            animTick(guest, ms);
        }
        animTick(manager, ms);
        if (guestWait > 0) {
            guestWait = Math.max(0, guestWait - ms);
            if (guestWait == 0) {
                animate(guest, "standing");
                if (guest.introParticles) {
                    for (var i = 0; i < guest.introParticles.number; i++) {
                        var angle = Math.random() * Math.PI * 2;
                        var dist = Math.random() * 180;
                        var speed = guest.introParticles.speed * (Math.random() + 0.5);
                        particles.push({
                            color: guest.introParticles.color,
                            size: guest.introParticles.size,
                            x: w / 2 + Math.cos(angle) * dist,
                            y: h / 2 + Math.sin(angle) * dist,
                            dx: Math.cos(angle) * speed,
                            dy: Math.sin(angle) * speed,
                            life: guest.introParticles.life
                        });
                    }
                }
            }
        }
    }
}

function person(person, x, y, active) {
    var bodyX = x;
    var bodyY = y + 110;
    var headX = x + 10;
    var headY = y - 110;
    var toolX = x - 160;
    var toolY = y - 20;
    var body = active && person.activeBody ? person.activeBody : person.body;
    var head = active && person.activeHead ? person.activeHead : person.head;
    var tool = active && person.activeTool ? person.activeTool : person.tool;
    var t = person.animationT;
    switch (person.animation) {
        case "activating":
            bodyY += Math.sin(t * 0.008) * 80;
            headY -= Math.sin(t * 0.008) * 80;
            if (t % 385 < 385 / 2) {
                body = person.body;
                head = person.head;
                tool = person.tool;
            } else {
                body = person.activeBody ? person.activeBody : person.body;
                head = person.activeHead ? person.activeHead : person.head;
                tool = person.activeTool ? person.activeTool : person.tool;
            }
            break;
        case "moving":
            bodyY -= Math.abs(Math.sin(t * 0.005)) * 50;
            headY -= Math.abs(Math.sin(t * 0.005 + 0.1)) * 50;
            toolY -= Math.abs(Math.sin(t * 0.005 + 0.2)) * 50;
            break;
        case "killing":
            bodyX += Math.abs(Math.sin(t * 0.005)) * 10;
            toolX -= Math.abs(Math.sin(t * 0.005)) * 50;
            toolY += Math.abs(Math.sin(t * 0.005)) * 20;
            headY += Math.abs(Math.sin(t * 0.005)) * 10;
            break;
        case "neutralizing":
            toolX -= 40;
            toolY -= 40 + Math.sin(t * 0.005) * 10;
            break;
        case "seducing":
            bodyX += Math.sin(t * 0.005) * 10;
            break;
        case "angry":
            headY -= Math.abs(Math.sin(t * 0.025)) * 20 - 30;
            toolX -= Math.abs(Math.sin(t * 0.025)) * 20 - 20;
            bodyX += Math.abs(Math.sin(t * 0.025)) * 5;
            break;
        case "fucking":
            bodyX -= Math.abs(Math.sin(t * Math.min(0.01, 0.004 + t * 0.000001))) * 50 - 20;
            headX += Math.abs(Math.sin(t * Math.min(0.01, 0.004 + t * 0.000001))) * 10 - 10;
            headY += 20;
            break;
        case "talking":
            headY -= Math.abs(Math.sin(t * 0.01)) * 20;
            break;
        case "suicide":
            break;
    }
    img(body, bodyX, bodyY);
    img(head, headX, headY);
    img(tool, toolX, toolY);
}

var images = {};

function img(name, x, y) {
    if (name == null) { return; }
    if (!images[name]) {
        images[name] = new Image();
        images[name].src = "graphics/" + name + ".png";
    }
    var img = images[name];
    c.drawImage(img, x - img.width / 2, y - img.height / 2);
}

function text(text, x, y) {
    c.font = "18px Serif";
    var sz = c.measureText(text);
    var h = 18;
    c.fillStyle = "black";
    c.fillRect(x - sz.width / 2 - 12, y - h / 2 - 12, sz.width + 24, h + 24);
    c.fillStyle = "white";
    c.fillRect(x - sz.width / 2 - 10, y - h / 2 - 10, sz.width + 20, h + 20);
    c.fillStyle = "black";
    c.fillText(text, x - sz.width / 2, y + 6);
}

function speech(speaker, text, x, y) {
    c.font = "18px Serif";
    var sz = c.measureText(text);
    var h = 18;
    c.fillStyle = "black";
    c.fillRect(x - sz.width / 2 - 12, y - h / 2 - 12, sz.width + 24, h + 24);
    var sz2 = c.measureText(speaker);
    c.fillRect(x - sz2.width / 2 - 12, y - h * 3 / 2 - 24, sz2.width + 24, h + 14);
    c.fillStyle = "white";
    c.fillRect(x - sz.width / 2 - 10, y - h / 2 - 10, sz.width + 20, h + 20);
    c.fillText(speaker, x - sz2.width / 2, y - h * 3 / 2 - 2);
    c.fillStyle = "black";
    c.fillText(text, x - sz.width / 2, y + 6);
}

var w = 0;
var h = 0;
var scale = 1.0;

function draw() {
    c.fillStyle = "#444444";
    c.fillRect(0, 0, canvas.width, canvas.height);
    c.resetTransform();
    scale = canvas.height / 700.0;
    w = canvas.width / scale;
    h = 700;
    c.scale(scale, scale);
    if (night) {
        img("rooms-night", w / 2, h / 2);
        c.translate(w / 2 - 500, 0);
        for (var i = 0; i < rooms.length; i++) {
            var room = rooms[i];
            var occupant = room.occupant;
            c.translate(occupant.x, occupant.y);
            c.scale(0.2, 0.2);
            person(occupant, 0, 0, occupant.active);
            c.resetTransform();
            c.scale(scale, scale);
            c.translate(w / 2 - 500, 0);
        }
    } else if (assignGuest) {
        img("rooms", w / 2, h / 2);
        c.translate(w / 2 - 500, 0);
        for (var i = 0; i < rooms.length; i++) {
            var room = rooms[i];
            if (room.occupant) {
                c.translate(room.x + room.w / 2, room.y + room.h * 3 / 4);
                c.scale(0.2, 0.2);
                person(room.occupant, 0, 0, false);
                c.resetTransform();
                c.scale(scale, scale);
                c.translate(w / 2 - 500, 0);
            } else if (cursor.x / scale > room.x + w / 2 - 500 && cursor.x / scale < room.x + room.w + w / 2 - 500 && cursor.y / scale > room.y && cursor.y / scale < room.y + room.h) {
                c.fillStyle = "rgba(255, 255, 255, 0.5)";
                c.fillRect(room.x, room.y, room.w, room.h);
            }
            speech(room.name, room.occupant ? room.occupant.name : "Empty", room.x + room.w / 2, room.y + room.h / 4);
        }
        c.resetTransform();
        c.translate(cursor.x, cursor.y);
        c.scale(scale * 0.2, scale * 0.2);
        person(guest, 0, 0, false);
    } else {
        if (intro) {
            img("lobby-bg", w / 2, h / 2);
            person(manager, w / 2, h / 2, false);
            img("lobby-fg", w / 2, h * 0.8);
            speech("Hotel Manager", introLines[introLine], w / 2, h * 0.8);
            return;
        }
        if (managerOut) {
            img("lobby-bg", w / 2, h / 2);
            person(manager, w / 2 + managerX, h / 2, false);
            img("lobby-fg", w / 2, h * 0.8);
            return;
        }
        img("lobby-bg", w / 2, h / 2);
        if (guestWait == 0) {
            person(guest, w / 2, h / 2, false);
        } else if (!guest.introParticles) {
            c.translate(w / 2, h / 2 + guestWait / 6);
            c.scale(1 - guestWait / 600, 1 - guestWait / 600);
            person(guest, 0, 0);
            c.resetTransform();
            c.scale(scale, scale);
        }
        for (var i = 0; i < particles.length; i++) {
            var p = particles[i];
            c.fillColor = p.color;
            c.beginPath();
            c.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            c.fill();
        }
        img("lobby-fg", w / 2, h * 0.8);
        if (guestSaidHello) {
            speech(guest.name, guest.intro, w / 2, h * 0.8);
            c.fillStyle = "#b3a221";
            c.fillRect(w / 2 - 100, 600, 200, 50);
            c.fillStyle = "#dac739";
            if (cursor.x / scale > w / 2 - 100 && cursor.x / scale < w / 2 + 100 && cursor.y / scale > 600 && cursor.y / scale < 650) {
                c.fillStyle = "#e2d363";
            }
            c.fillRect(w / 2 - 98, 602, 196, 46);
            c.fillStyle = "black";
            c.fillText("ASSIGN ROOM", w / 2 - c.measureText("ASSIGN ROOM").width / 2, 632);
        }
    }
}

var canvas = document.getElementById("gameCanvas");
var c = canvas.getContext("2d");
var keys = {};
var click = null;
var mouseDown = false;
var cursor = {x: 300, y: 300};

// Listen for key presses.
function canvasKeyDown(e) {
    keys[String.fromCharCode(e.which)] = true;
}

function canvasKeyUp(e) {
    keys[String.fromCharCode(e.which)] = false;
}

function down(key) {
    return !!keys[key];
}

$('body').keydown(canvasKeyDown);
$('body').keyup(canvasKeyUp);

// Listen for mouse stuff.
function canvasClick(e) {
    click = { "x": e.offsetX, "y": e.offsetY };
}

function canvasMouseDown(e) {
    mouseDown = true;
}

function canvasMouseUp(e) {
    mouseDown = false;
}

function canvasMove(e) {
    cursor = { "x": e.offsetX, "y": e.offsetY };
}

$('#gameCanvas').click(canvasClick).mousemove(canvasMove).mousedown(canvasMouseDown).mouseup(canvasMouseUp);

// Set up game loop.
var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
var lastUpdate = new Date().getTime();

function nextFrame() {
    var currentTime = new Date().getTime();
    input(currentTime - lastUpdate);
    click = null;
    update(currentTime - lastUpdate);
    draw();
    lastUpdate = currentTime;
    requestAnimationFrame(nextFrame);
}

// Once everything is set up, start game loop.
requestAnimationFrame(nextFrame);

jQuery(window).resize(function() {
    canvas.width = window.innerWidth - 20;
    canvas.height = window.innerHeight - 20;
});
jQuery(window).ready(function() {
    canvas.width = window.innerWidth - 20;
    canvas.height = window.innerHeight - 20;
});
 
/*canvas.addEventListener("click", function() {
    if (canvas.webkitRequestFullScreen) {
        canvas.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
    } else if (canvas.mozRequestFullScreen) {
        canvas.mozRequestFullScreen();
    } else if (canvas.requestFullScreen) {
        canvas.requestFullScreen();
    }
});*/
        </script>
    </body>
</html>
